<!DOCTYPE html>
<html>
<head>
  <title>Live Location Share with Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    #map { flex: 1; }
    #controls {
      background: #f9f9f9;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      transition: all 0.3s ease;
    }
    #link {
      flex: 1 1 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: all;
      border: 1px solid #ccc;
      padding: 6px 8px;
      border-radius: 4px;
      background: #fff;
    }
    button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    #chat {
      height: 200px;
      border-top: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-size: 14px;
      border-bottom: 1px solid #ddd;
    }
    #messages .message {
      margin-bottom: 6px;
    }
    #messages .message .user {
      font-weight: bold;
      margin-right: 6px;
      color: #007bff;
    }
    #chatForm {
      display: flex;
      padding: 6px;
    }
    #chatForm input[type=text] {
      flex: 1;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #chatForm button {
      margin-left: 6px;
      padding: 6px 14px;
      font-size: 14px;
    }
    #nameInput {
      width: 160px;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #status {
      font-size: 12px;
      color: green;
      margin-left: 10px;
      font-style: italic;
    }
    #errorMsg {
      color: red;
      font-weight: bold;
      padding: 10px;
      text-align: center;
    }
    /* Hide UI in full map mode */
    .hidden-ui {
      display: none !important;
    }
  </style>
</head>
<body>

  <div id="controls">
    <input id="nameInput" type="text" placeholder="Enter your name" maxlength="20" />
    <button id="startBtn" style="display:none;">Start Sharing Location</button>
    <button id="joinBtn" style="display:none;">Join Room</button>
    <button id="createRoomBtn">Create Room</button>
    <div id="link" title="Click to copy link" style="display:none;"></div>
    <button id="copyBtn" style="display:none;">Copy Link</button>
    <button id="fullMapBtn" style="display:none;">Full Map View</button>
    <button id="unhideBtn" style="display:none;">Unhide UI</button>
    <div id="status"></div>
  </div>

  <div id="errorMsg"></div>

  <div id="map" style="display:none;"></div>

  <div id="chat" style="display:none;">
    <div id="messages"></div>
    <form id="chatForm">
      <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off" maxlength="200" />
      <button type="submit">Send</button>
    </form>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import L from 'https://cdn.skypack.dev/leaflet';

  const firebaseConfig = {
    apiKey: "AIzaSyDdKPNmsXTZn0ZwWtCPByBR7sFX-rhllHg",
    authDomain: "locationsharing-67ac1.firebaseapp.com",
    databaseURL: "https://locationsharing-67ac1-default-rtdb.firebaseio.com",
    projectId: "locationsharing-67ac1",
    storageBucket: "locationsharing-67ac1.firebasestorage.app",
    messagingSenderId: "693067895439",
    appId: "1:693067895439:web:35dd6cab2bfe122428d6fa",
    measurementId: "G-8JNVJ0V8VV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Elements
  const linkDiv = document.getElementById('link');
  const copyBtn = document.getElementById('copyBtn');
  const startBtn = document.getElementById('startBtn');
  const joinBtn = document.getElementById('joinBtn');
  const nameInput = document.getElementById('nameInput');
  const statusDiv = document.getElementById('status');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const messagesDiv = document.getElementById('messages');
  const controlsDiv = document.getElementById('controls');
  const errorMsg = document.getElementById('errorMsg');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const mapDiv = document.getElementById('map');
  const chatDiv = document.getElementById('chat');
  const fullMapBtn = document.getElementById('fullMapBtn');
  const unhideBtn = document.getElementById('unhideBtn');

  // Flags & variables
  let room = null;
  let isSharer = false;
  let yourMarker = null;
  let sharedMarker = {};
  let watchId = null;
  let userName = null;
  const ROOM_EXPIRATION_MS = 60 * 60 * 1000;
  let isFullMapView = false;

  // Leaflet map init (centered world view)
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // Utility to escape HTML for chat safety
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }

  // Update share link display
  function updateLink() {
    const shareURL = window.location.origin + window.location.pathname + '?room=' + room;
    linkDiv.textContent = shareURL;
  }

  // Copy share link
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(linkDiv.textContent).then(() => {
      alert("Link copied to clipboard!");
    });
  };
  linkDiv.onclick = copyBtn.onclick;

  // Local storage ownership flag helpers
  function setOwnerFlag(roomId) {
    localStorage.setItem('room_owner_' + roomId, 'true');
  }
  function getOwnerFlag(roomId) {
    return localStorage.getItem('room_owner_' + roomId) === 'true';
  }

  // Validate room in DB (check existence and expiration)
  async function validateRoom(roomId) {
    const metaSnap = await get(ref(db, `rooms/${roomId}/meta`));
    if (!metaSnap.exists()) return false;
    const meta = metaSnap.val();
    if (!meta.lastUpdate) return false;
    if (Date.now() - meta.lastUpdate > ROOM_EXPIRATION_MS) return false;
    return true;
  }

  // On page load, parse room from URL
  function getRoomFromURL() {
    const params = new URLSearchParams(window.location.search);
    const r = params.get('room');
    if (r && typeof r === 'string' && r.match(/^[a-zA-Z0-9_-]{6,}$/)) {
      return r;
    }
    return null;
  }

  // Generate random room id
  function randomRoomId() {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let id = '';
    for(let i=0; i<8; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }

  // Show error message
  function showError(msg) {
    errorMsg.textContent = msg;
  }
  function clearError() {
    errorMsg.textContent = '';
  }

  // Initialize map markers update for sharer
  function startSharingLocation() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }
    isSharer = true;
    statusDiv.textContent = 'Sharing your location...';
    watchId = navigator.geolocation.watchPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        // Update marker on map
        if (!yourMarker) {
          yourMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('You');
          map.setView([latitude, longitude], 16);
        } else {
          yourMarker.setLatLng([latitude, longitude]);
        }
        // Update Firebase
        set(ref(db, `rooms/${room}/locations/owner`), {
          lat: latitude,
          lng: longitude,
          timestamp: Date.now()
        });
        // Update meta timestamp
        updateMetaTimestamp();
      },
      err => {
        alert('Error getting location: ' + err.message);
      },
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
    );
    startBtn.style.display = 'none';
    joinBtn.style.display = 'none';
    nameInput.disabled = true;
    createRoomBtn.style.display = 'none';
    fullMapBtn.style.display = 'inline-block';
    chatDiv.style.display = 'flex';
    mapDiv.style.display = 'block';
    copyBtn.style.display = 'inline-block';
  }

  // Update meta lastUpdate timestamp
  function updateMetaTimestamp() {
    set(ref(db, `rooms/${room}/meta`), {
      lastUpdate: Date.now()
    });
  }

  // Join as viewer (non-sharer)
  function joinRoom() {
    if (!userName || userName.trim().length < 1) {
      alert('Please enter your name.');
      return;
    }
    isSharer = false;
    nameInput.disabled = true;
    joinBtn.style.display = 'none';
    createRoomBtn.style.display = 'none';
    startBtn.style.display = 'none';
    copyBtn.style.display = 'none';
    fullMapBtn.style.display = 'inline-block';
    chatDiv.style.display = 'flex';
    mapDiv.style.display = 'block';
    statusDiv.textContent = 'Joined room: ' + room;
    listenToOwnerLocation();
    listenToChat();
  }

  // Listen for sharer's location updates
  function listenToOwnerLocation() {
    const locRef = ref(db, `rooms/${room}/locations/owner`);
    onValue(locRef, (snap) => {
      if (!snap.exists()) return;
      const loc = snap.val();
      if (!loc.lat || !loc.lng) return;
      if (!sharedMarker.owner) {
        sharedMarker.owner = L.marker([loc.lat, loc.lng], { icon: L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41]
        })}).addTo(map).bindPopup('Owner Location');
        map.setView([loc.lat, loc.lng], 16);
      } else {
        sharedMarker.owner.setLatLng([loc.lat, loc.lng]);
      }
    });
  }

  // Chat messaging functions
  function listenToChat() {
    const chatRef = ref(db, `rooms/${room}/chat`);
    onValue(chatRef, (snap) => {
      messagesDiv.innerHTML = '';
      if (!snap.exists()) return;
      const data = snap.val();
      Object.entries(data).forEach(([msgId, msg]) => {
        addMessageToChat(msg.name, msg.text);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }
  function addMessageToChat(name, text) {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `<span class="user">${escapeHtml(name)}:</span> ${escapeHtml(text)}`;
    messagesDiv.appendChild(div);
  }

  // Send chat message
  chatForm.onsubmit = (e) => {
    e.preventDefault();
    if (!chatInput.value.trim()) return;
    const chatRef = ref(db, `rooms/${room}/chat`);
    const newMsgRef = push(chatRef);
    set(newMsgRef, {
      name: userName,
      text: chatInput.value.trim(),
      timestamp: Date.now()
    });
    chatInput.value = '';
  };

  // Handle creating a new room
  createRoomBtn.onclick = () => {
    userName = nameInput.value.trim();
    if (userName.length < 1) {
      alert('Please enter your name before creating a room.');
      return;
    }
    room = randomRoomId();
    setOwnerFlag(room);
    updateLink();
    startBtn.style.display = 'inline-block';
    joinBtn.style.display = 'none';
    copyBtn.style.display = 'inline-block';
    linkDiv.style.display = 'inline-block';
    createRoomBtn.style.display = 'none';
    nameInput.disabled = true;
    errorMsg.textContent = '';
    chatDiv.style.display = 'none';
    mapDiv.style.display = 'none';
    statusDiv.textContent = 'Room created: ' + room;
  };

  // Start sharing location button
  startBtn.onclick = () => {
    startSharingLocation();
  };

  // Join room button
  joinBtn.onclick = () => {
    userName = nameInput.value.trim();
    if (!userName) {
      alert('Please enter your name before joining.');
      return;
    }
    joinRoom();
  };

  // Full map view toggle
  fullMapBtn.onclick = () => {
    isFullMapView = true;
    controlsDiv.querySelectorAll('input, button, #link, #status').forEach(el => {
      if (el !== unhideBtn) el.classList.add('hidden-ui');
    });
    chatDiv.classList.add('hidden-ui');
    unhideBtn.style.display = 'inline-block';
    fullMapBtn.style.display = 'none';
  };
  unhideBtn.onclick = () => {
    isFullMapView = false;
    controlsDiv.querySelectorAll('input, button, #link, #status').forEach(el => {
      el.classList.remove('hidden-ui');
    });
    chatDiv.classList.remove('hidden-ui');
    unhideBtn.style.display = 'none';
    fullMapBtn.style.display = 'inline-block';
  };

  // Initial setup on page load
  (async () => {
    const r = getRoomFromURL();
    if (!r) {
      // No room param - show create room UI
      createRoomBtn.style.display = 'inline-block';
      startBtn.style.display = 'none';
      joinBtn.style.display = 'none';
      copyBtn.style.display = 'none';
      linkDiv.style.display = 'none';
      fullMapBtn.style.display = 'none';
      unhideBtn.style.display = 'none';
      chatDiv.style.display = 'none';
      mapDiv.style.display = 'none';
      statusDiv.textContent = '';
      return;
    }

    // We have a room param, validate it
    room = r;
    const valid = await validateRoom(room);
    if (!valid) {
      showError('This room link is invalid or expired.');
      createRoomBtn.style.display = 'inline-block';
      startBtn.style.display = 'none';
      joinBtn.style.display = 'none';
      copyBtn.style.display = 'none';
      linkDiv.style.display = 'none';
      fullMapBtn.style.display = 'none';
      unhideBtn.style.display = 'none';
      chatDiv.style.display = 'none';
      mapDiv.style.display = 'none';
      statusDiv.textContent = '';
      return;
    }

    clearError();

    // Show link for copy anyway
    updateLink();
    linkDiv.style.display = 'inline-block';
    copyBtn.style.display = 'inline-block';
    fullMapBtn.style.display = 'inline-block';
    unhideBtn.style.display = 'none';
    createRoomBtn.style.display = 'none';

    // Check if current user is room owner (sharer)
    if (getOwnerFlag(room)) {
      // Sharer
      userName = nameInput.value.trim() || 'Owner';
      nameInput.value = userName;
      nameInput.disabled = true;
      startBtn.style.display = 'inline-block';
      joinBtn.style.display = 'none';
      chatDiv.style.display = 'none';
      mapDiv.style.display = 'none';
      statusDiv.textContent = 'You are the sharer. Click Start Sharing Location.';
    } else {
      // Viewer - show name input and join button
      nameInput.disabled = false;
      startBtn.style.display = 'none';
      joinBtn.style.display = 'inline-block';
      chatDiv.style.display = 'none';
      mapDiv.style.display = 'none';
      statusDiv.textContent = 'Enter your name and click Join Room.';
    }
  })();

</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
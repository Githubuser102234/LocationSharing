<!DOCTYPE html>
<html>
<head>
  <title>Live Location Share with Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    #map { flex: 1; }
    #controls {
      background: #f9f9f9;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    #link {
      flex: 1 1 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: all;
      border: 1px solid #ccc;
      padding: 6px 8px;
      border-radius: 4px;
      background: #fff;
    }
    button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #chat {
      height: 200px;
      border-top: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      background: #fafafa;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-size: 14px;
      border-bottom: 1px solid #ddd;
    }
    #messages .message {
      margin-bottom: 6px;
    }
    #messages .message .user {
      font-weight: bold;
      margin-right: 6px;
      color: #007bff;
    }
    #chatForm {
      display: flex;
      padding: 6px;
    }
    #chatForm input[type=text] {
      flex: 1;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #chatForm button {
      margin-left: 6px;
      padding: 6px 14px;
      font-size: 14px;
    }
    #nameInput {
      width: 160px;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #status {
      font-size: 12px;
      color: green;
      margin-left: 10px;
      font-style: italic;
    }
    #errorMsg {
      color: red;
      font-weight: bold;
      padding: 10px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="controls">
    <input id="nameInput" type="text" placeholder="Enter your name" maxlength="20" />
    <button id="startBtn" style="display:none;">Start Sharing Location</button>
    <button id="joinBtn" style="display:none;">Join Room</button>
    <button id="createRoomBtn">Create Room</button>
    <div id="link" title="Click to copy link" style="display:none;"></div>
    <button id="copyBtn" style="display:none;">Copy Link</button>
    <div id="status"></div>
  </div>

  <div id="errorMsg"></div>

  <div id="map" style="display:none;"></div>

  <div id="chat" style="display:none;">
    <div id="messages"></div>
    <form id="chatForm">
      <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off" maxlength="200" />
      <button type="submit">Send</button>
    </form>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import L from 'https://cdn.skypack.dev/leaflet';

  const firebaseConfig = {
    apiKey: "AIzaSyDdKPNmsXTZn0ZwWtCPByBR7sFX-rhllHg",
    authDomain: "locationsharing-67ac1.firebaseapp.com",
    databaseURL: "https://locationsharing-67ac1-default-rtdb.firebaseio.com",
    projectId: "locationsharing-67ac1",
    storageBucket: "locationsharing-67ac1.firebasestorage.app",
    messagingSenderId: "693067895439",
    appId: "1:693067895439:web:35dd6cab2bfe122428d6fa",
    measurementId: "G-8JNVJ0V8VV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Elements
  const linkDiv = document.getElementById('link');
  const copyBtn = document.getElementById('copyBtn');
  const startBtn = document.getElementById('startBtn');
  const joinBtn = document.getElementById('joinBtn');
  const nameInput = document.getElementById('nameInput');
  const statusDiv = document.getElementById('status');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const messagesDiv = document.getElementById('messages');
  const controlsDiv = document.getElementById('controls');
  const errorMsg = document.getElementById('errorMsg');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const mapDiv = document.getElementById('map');
  const chatDiv = document.getElementById('chat');

  // Flags & variables
  let room = null;
  let isSharer = false;
  let yourMarker = null;
  let sharedMarker = null;
  let watchId = null;
  let userName = null;
  const ROOM_EXPIRATION_MS = 60 * 60 * 1000;

  // Leaflet map init (centered world view)
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  function updateLink() {
    const shareURL = window.location.origin + window.location.pathname + '?room=' + room;
    linkDiv.textContent = shareURL;
  }

  copyBtn.onclick = () => {
    navigator.clipboard.writeText(linkDiv.textContent).then(() => {
      alert("Link copied to clipboard!");
    });
  };
  linkDiv.onclick = copyBtn.onclick;

  // Local storage ownership flag
  function setOwnerFlag(roomId) {
    localStorage.setItem('room_owner_' + roomId, 'true');
  }
  function getOwnerFlag(roomId) {
    return localStorage.getItem('room_owner_' + roomId) === 'true';
  }

  // Validate room from DB
  async function validateRoom(roomId) {
    const metaSnap = await get(ref(db, `rooms/${roomId}/meta`));
    if (!metaSnap.exists()) return false;
    const meta = metaSnap.val();
    if (!meta.lastUpdate) return false;
    if (Date.now() - meta.lastUpdate > ROOM_EXPIRATION_MS) return false;
    return true;
  }

  async function clearIfExpired(roomId) {
    const metaRef = ref(db, `rooms/${roomId}/meta`);
    onValue(metaRef, (snap) => {
      const meta = snap.val();
      if (meta && meta.lastUpdate && (Date.now() - meta.lastUpdate > ROOM_EXPIRATION_MS)) {
        remove(ref(db, `rooms/${roomId}`));
      }
    }, { onlyOnce: true });
  }

  function updateMetaTimestamp() {
    update(ref(db, `rooms/${room}/meta`), { lastUpdate: Date.now() });
  }

  // Start watching location with permission prompt
  function startSharing() {
    userName = nameInput.value.trim();
    if (!userName) {
      alert("Please enter your name before starting.");
      return;
    }
    setOwnerFlag(room);
    isSharer = true;

    // Show map & chat
    mapDiv.style.display = 'block';
    chatDiv.style.display = 'flex';
    startBtn.style.display = 'none';
    joinBtn.style.display = 'none';
    createRoomBtn.style.display = 'none';
    nameInput.disabled = true;
    linkDiv.style.display = 'block';
    copyBtn.style.display = 'inline-block';

    statusDiv.textContent = "Sharing your location...";

    // Get permission by requesting current position first (will prompt user)
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        watchLocation();
      },
      (err) => {
        errorMsg.textContent = 'Location permission denied or error: ' + err.message;
        statusDiv.textContent = '';
      },
      { enableHighAccuracy: true }
    );
  }

  function watchLocation() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
    }
    watchId = navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        updateMetaTimestamp();

        // Update own marker on map
        if (!yourMarker) {
          yourMarker = L.marker([lat, lng], { title: "You" }).addTo(map);
          map.setView([lat, lng], 15);
        } else {
          yourMarker.setLatLng([lat, lng]);
        }

        // Update location in DB
        set(ref(db, `rooms/${room}/locations/${userName}`), {
          lat, lng, timestamp: Date.now()
        });

      },
      err => {
        errorMsg.textContent = 'Error getting location updates: ' + err.message;
        statusDiv.textContent = '';
      },
      { enableHighAccuracy: true }
    );
  }

  // Join an existing room as viewer
  async function joinRoom() {
    userName = nameInput.value.trim();
    if (!userName) {
      alert("Please enter your name before joining.");
      return;
    }
    isSharer = false;

    mapDiv.style.display = 'block';
    chatDiv.style.display = 'flex';
    joinBtn.style.display = 'none';
    createRoomBtn.style.display = 'none';
    nameInput.disabled = true;

    statusDiv.textContent = "Joining room...";

    // Validate room
    const valid = await validateRoom(room);
    if (!valid) {
      errorMsg.textContent = "Room not found or expired.";
      statusDiv.textContent = '';
      return;
    }

    linkDiv.style.display = 'block';
    copyBtn.style.display = 'inline-block';
    updateLink();

    // Show markers for all users (including sharer)
    const locRef = ref(db, `rooms/${room}/locations`);
    onValue(locRef, (snap) => {
      const locs = snap.val() || {};
      // Remove markers for disconnected users
      Object.keys(locs).forEach(name => {
        if (name === userName) return; // skip own marker, viewers don't track their own position
        if (!sharedMarker) sharedMarker = {};
      });
      // Update markers for all others
      if (!sharedMarker) sharedMarker = {};
      for (const [name, loc] of Object.entries(locs)) {
        if (name === userName) continue; // viewers do not track their own location
        if (!sharedMarker[name]) {
          sharedMarker[name] = L.marker([loc.lat, loc.lng], {
            title: name,
            icon: L.icon({
              iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
              iconSize: [30, 30],
              iconAnchor: [15, 30],
              popupAnchor: [0, -30],
            })
          }).addTo(map);
        } else {
          sharedMarker[name].setLatLng([loc.lat, loc.lng]);
        }
      }
    });

    // Show messages & listen to chat
    listenChat();
  }

  // Create a new room ID and init
  function createRoom() {
    // Generate simple random 6 char room id (letters + numbers)
    room = Math.random().toString(36).slice(2, 8);
    setOwnerFlag(room);

    // Save meta immediately
    set(ref(db, `rooms/${room}/meta`), { lastUpdate: Date.now() });

    updateLink();
    linkDiv.style.display = 'block';
    copyBtn.style.display = 'inline-block';
    startBtn.style.display = 'inline-block';
    createRoomBtn.style.display = 'none';
    joinBtn.style.display = 'none';
    statusDiv.textContent = "Room created. Enter your name and start sharing.";

    // Show name input & buttons
    nameInput.disabled = false;
  }

  // Chat functions

  function sendMessage(text) {
    if (!room) return;
    if (!userName) return;
    if (!text.trim()) return;
    const chatRef = ref(db, `rooms/${room}/chat`);
    const message = {
      user: userName,
      text: text.trim(),
      timestamp: Date.now()
    };
    push(chatRef, message);
  }

  function listenChat() {
    const chatRef = ref(db, `rooms/${room}/chat`);
    onValue(chatRef, (snap) => {
      const data = snap.val() || {};
      messagesDiv.innerHTML = '';
      const sortedMessages = Object.values(data).sort((a, b) => a.timestamp - b.timestamp);
      for (const msg of sortedMessages) {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<span class="user">${escapeHtml(msg.user)}:</span> ${escapeHtml(msg.text)}`;
        messagesDiv.appendChild(div);
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }

  chatForm.onsubmit = e => {
    e.preventDefault();
    const text = chatInput.value;
    sendMessage(text);
    chatInput.value = '';
  };

  // On page load, parse URL for room
  function init() {
    const params = new URLSearchParams(window.location.search);
    room = params.get('room');
    if (room) {
      // Existing room - show join button & name input
      nameInput.style.display = 'inline-block';
      joinBtn.style.display = 'inline-block';
      createRoomBtn.style.display = 'none';
      startBtn.style.display = 'none';
      statusDiv.textContent = "Enter your name and join room.";
    } else {
      // No room param - show create room button & name input
      nameInput.style.display = 'inline-block';
      createRoomBtn.style.display = 'inline-block';
      startBtn.style.display = 'none';
      joinBtn.style.display = 'none';
      statusDiv.textContent = "Enter your name and create a room to start sharing.";
    }
  }

  startBtn.onclick = () => {
    if (!room) return alert("No room created.");
    startSharing();
    listenChat();
  };

  joinBtn.onclick = () => {
    joinRoom();
  };

  createRoomBtn.onclick = () => {
    createRoom();
  };

  init();

</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</body>
</html>